{"version":3,"file":"advice.factory.js","sources":["../../../../../commons/src/advices/advice.factory.ts"],"sourcesContent":["import { Advice, AdviceType, CompileAdvice } from './types';\nimport { Pointcut, PointcutPhase } from '../types';\nimport { AdviceError, WeavingError } from '../weaver/errors';\nimport { assert, getProto, isFunction } from '@aspectjs/core/utils';\nimport { _getWeaverContext } from '../weaver';\nimport { AdviceTarget } from '../annotation/target/annotation-target';\n\n/**\n * @internal\n */\nexport class _AdviceFactory {\n    static create(pointcut: Pointcut, target: AdviceTarget): Advice {\n        assert(\n            !(pointcut.type === AdviceType.PROPERTY) ||\n                pointcut.ref.startsWith('property#get') ||\n                pointcut.ref.startsWith('property#set'),\n        );\n        const [aspect, propertyKey] = [target.proto, target.propertyKey];\n\n        assert(isFunction(aspect[propertyKey]));\n        let advice: Advice;\n        if (pointcut.phase === PointcutPhase.COMPILE) {\n            // prevent @Compile advices to be called twice\n            advice = function (...args: any[]) {\n                const a = advice as CompileAdvice;\n                advice = (() => {\n                    throw new WeavingError(`${a} already applied`);\n                }) as any;\n\n                return aspect[propertyKey].apply(this, args);\n            } as Advice;\n        } else {\n            advice = function (...args: any[]) {\n                return aspect[propertyKey].apply(this, args);\n            } as Advice;\n        }\n\n        advice.pointcut = pointcut;\n        advice.aspect = aspect;\n\n        Reflect.defineProperty(advice, Symbol.toPrimitive, {\n            value: () =>\n                `@${pointcut.phase}(${pointcut.annotation}) ${aspect.constructor.name}.${String(propertyKey)}()`,\n        });\n\n        Reflect.defineProperty(advice, 'name', {\n            value: propertyKey,\n        });\n\n        if (pointcut.phase === PointcutPhase.COMPILE) {\n            if (pointcut.ref.startsWith('property#set')) {\n                // @Compile(on.property.setter) are forbidden\n                // because PropertyDescriptor can only be setup for both setter & getter at once.\n                throw new AdviceError(advice, `Advice cannot be applied on property setter`);\n            }\n        }\n\n        // assert the weaver is loaded before invoking the underlying decorator\n        const weaverContext = _getWeaverContext();\n        if (!weaverContext) {\n            throw new Error(\n                `Cannot create aspect ${\n                    getProto(aspect).constructor.name ?? ''\n                } before \"setWeaverContext()\" has been called`,\n            );\n        }\n\n        return advice;\n    }\n}\n"],"names":["AdviceType"],"mappings":";;;;;;;AAOA;;;MAGa,cAAc;IACvB,OAAO,MAAM,CAAC,QAAkB,EAAE,MAAoB;;QAClD,MAAM,CACF,EAAE,QAAQ,CAAC,IAAI,KAAKA,cAAU,CAAC,QAAQ,CAAC;YACpC,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,cAAc,CAAC;YACvC,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,cAAc,CAAC,CAC9C,CAAC;QACF,MAAM,CAAC,MAAM,EAAE,WAAW,CAAC,GAAG,CAAC,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,WAAW,CAAC,CAAC;QAEjE,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC;QACxC,IAAI,MAAc,CAAC;QACnB,IAAI,QAAQ,CAAC,KAAK,KAAK,aAAa,CAAC,OAAO,EAAE;;YAE1C,MAAM,GAAG,UAAU,GAAG,IAAW;gBAC7B,MAAM,CAAC,GAAG,MAAuB,CAAC;gBAClC,MAAM,IAAI;oBACN,MAAM,IAAI,YAAY,CAAC,GAAG,CAAC,kBAAkB,CAAC,CAAC;iBAClD,CAAQ,CAAC;gBAEV,OAAO,MAAM,CAAC,WAAW,CAAC,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;aACtC,CAAC;SACf;aAAM;YACH,MAAM,GAAG,UAAU,GAAG,IAAW;gBAC7B,OAAO,MAAM,CAAC,WAAW,CAAC,CAAC,KAAK,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;aACtC,CAAC;SACf;QAED,MAAM,CAAC,QAAQ,GAAG,QAAQ,CAAC;QAC3B,MAAM,CAAC,MAAM,GAAG,MAAM,CAAC;QAEvB,OAAO,CAAC,cAAc,CAAC,MAAM,EAAE,MAAM,CAAC,WAAW,EAAE;YAC/C,KAAK,EAAE,MACH,IAAI,QAAQ,CAAC,KAAK,IAAI,QAAQ,CAAC,UAAU,KAAK,MAAM,CAAC,WAAW,CAAC,IAAI,IAAI,MAAM,CAAC,WAAW,CAAC,IAAI;SACvG,CAAC,CAAC;QAEH,OAAO,CAAC,cAAc,CAAC,MAAM,EAAE,MAAM,EAAE;YACnC,KAAK,EAAE,WAAW;SACrB,CAAC,CAAC;QAEH,IAAI,QAAQ,CAAC,KAAK,KAAK,aAAa,CAAC,OAAO,EAAE;YAC1C,IAAI,QAAQ,CAAC,GAAG,CAAC,UAAU,CAAC,cAAc,CAAC,EAAE;;;gBAGzC,MAAM,IAAI,WAAW,CAAC,MAAM,EAAE,6CAA6C,CAAC,CAAC;aAChF;SACJ;;QAGD,MAAM,aAAa,GAAG,iBAAiB,EAAE,CAAC;QAC1C,IAAI,CAAC,aAAa,EAAE;YAChB,MAAM,IAAI,KAAK,CACX,wBACI,MAAA,QAAQ,CAAC,MAAM,CAAC,CAAC,WAAW,CAAC,IAAI,mCAAI,EACzC,8CAA8C,CACjD,CAAC;SACL;QAED,OAAO,MAAM,CAAC;KACjB;;;;;"}