{"version":3,"file":"parameter-weaving-strategy.js","sources":["../../../../../../src/weaver/jit/strategies/parameter-weaving-strategy.ts"],"sourcesContent":["import { AnnotationType, CompileAdvice, MutableAdviceContext } from '@aspectjs/core/commons';\nimport { getOrComputeMetadata } from '@aspectjs/core/utils';\nimport { _MethodWeavingStrategy } from './method-weaving-strategy';\n\nconst _defineProperty = Object.defineProperty;\n\nexport class _ParameterWeavingStrategy<T> extends _MethodWeavingStrategy<T> {\n    constructor() {\n        super();\n    }\n\n    compile(\n        ctxt: MutableAdviceContext<T, AnnotationType.METHOD>,\n        advices: CompileAdvice<T, AnnotationType.METHOD>[],\n    ): PropertyDescriptor & { value: (...args: any[]) => any } {\n        const target = ctxt.target;\n        // save & restore original descriptor\n        const originalDescriptor = getOrComputeMetadata(\n            'aspectjs.originalPropertyDescriptor',\n            target.proto,\n            ctxt.target.propertyKey,\n            () => {\n                return { ...Reflect.getOwnPropertyDescriptor(target.proto, target.propertyKey) };\n            },\n            true,\n        );\n\n        Reflect.defineProperty(target.proto, target.propertyKey, originalDescriptor);\n        Reflect.defineMetadata(\n            'aspectjs.originalMethodDescriptor',\n            originalDescriptor,\n            target.proto,\n            target.propertyKey,\n        );\n\n        return super.compile(ctxt, advices);\n    }\n\n    finalize(ctxt: MutableAdviceContext<T, AnnotationType.METHOD>, jp: (args?: any[]) => T): PropertyDescriptor {\n        const newDescriptor = super.finalize(ctxt, jp);\n\n        Reflect.defineProperty(ctxt.target.proto, ctxt.target.propertyKey, newDescriptor);\n\n        // We want any further method advice t use this descriptor as a reference\n        Reflect.defineMetadata(\n            'aspectjs.originalMethodDescriptor',\n            newDescriptor,\n            ctxt.target.proto,\n            ctxt.target.propertyKey,\n        );\n\n        // Override method descriptor from parameter decorator is not allowed because return value of this parameter decorators is ignored\n        // Moreover, Reflect.decorate will overwrite any changes made on proto[propertyKey]\n        // We monkey patch Object.defineProperty to prevent this;\n        Object.defineProperty = function (o: any, p: PropertyKey, attributes: PropertyDescriptor & ThisType<any>) {\n            if (o === ctxt.target.proto && p === ctxt.target.propertyKey) {\n                // restore original defineProperty method\n                Object.defineProperty = _defineProperty;\n\n                // if attempt to write an enhanced descriptor... let go\n                if (Reflect.getOwnMetadata('aspectjs.enhancedMethodDescriptor', attributes)) {\n                    return Object.defineProperty(o, p, attributes);\n                } else {\n                    // prevent writing back old descriptor\n                    return newDescriptor;\n                }\n            }\n\n            return _defineProperty(o, p, attributes);\n        };\n\n        return newDescriptor as any;\n    }\n}\n"],"names":[],"mappings":";;;AAIA,MAAM,eAAe,GAAG,MAAM,CAAC,cAAc,CAAC;MAEjC,yBAA6B,SAAQ,sBAAyB;IACvE;QACI,KAAK,EAAE,CAAC;KACX;IAED,OAAO,CACH,IAAoD,EACpD,OAAkD;QAElD,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;;QAE3B,MAAM,kBAAkB,GAAG,oBAAoB,CAC3C,qCAAqC,EACrC,MAAM,CAAC,KAAK,EACZ,IAAI,CAAC,MAAM,CAAC,WAAW,EACvB;YACI,yBAAY,OAAO,CAAC,wBAAwB,CAAC,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,WAAW,CAAC,EAAG;SACpF,EACD,IAAI,CACP,CAAC;QAEF,OAAO,CAAC,cAAc,CAAC,MAAM,CAAC,KAAK,EAAE,MAAM,CAAC,WAAW,EAAE,kBAAkB,CAAC,CAAC;QAC7E,OAAO,CAAC,cAAc,CAClB,mCAAmC,EACnC,kBAAkB,EAClB,MAAM,CAAC,KAAK,EACZ,MAAM,CAAC,WAAW,CACrB,CAAC;QAEF,OAAO,KAAK,CAAC,OAAO,CAAC,IAAI,EAAE,OAAO,CAAC,CAAC;KACvC;IAED,QAAQ,CAAC,IAAoD,EAAE,EAAuB;QAClF,MAAM,aAAa,GAAG,KAAK,CAAC,QAAQ,CAAC,IAAI,EAAE,EAAE,CAAC,CAAC;QAE/C,OAAO,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,EAAE,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE,aAAa,CAAC,CAAC;;QAGlF,OAAO,CAAC,cAAc,CAClB,mCAAmC,EACnC,aAAa,EACb,IAAI,CAAC,MAAM,CAAC,KAAK,EACjB,IAAI,CAAC,MAAM,CAAC,WAAW,CAC1B,CAAC;;;;QAKF,MAAM,CAAC,cAAc,GAAG,UAAU,CAAM,EAAE,CAAc,EAAE,UAA8C;YACpG,IAAI,CAAC,KAAK,IAAI,CAAC,MAAM,CAAC,KAAK,IAAI,CAAC,KAAK,IAAI,CAAC,MAAM,CAAC,WAAW,EAAE;;gBAE1D,MAAM,CAAC,cAAc,GAAG,eAAe,CAAC;;gBAGxC,IAAI,OAAO,CAAC,cAAc,CAAC,mCAAmC,EAAE,UAAU,CAAC,EAAE;oBACzE,OAAO,MAAM,CAAC,cAAc,CAAC,CAAC,EAAE,CAAC,EAAE,UAAU,CAAC,CAAC;iBAClD;qBAAM;;oBAEH,OAAO,aAAa,CAAC;iBACxB;aACJ;YAED,OAAO,eAAe,CAAC,CAAC,EAAE,CAAC,EAAE,UAAU,CAAC,CAAC;SAC5C,CAAC;QAEF,OAAO,aAAoB,CAAC;KAC/B;;;;;"}