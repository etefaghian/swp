{"version":3,"file":"method-weaving-strategy.js","sources":["../../../../../../src/weaver/jit/strategies/method-weaving-strategy.ts"],"sourcesContent":["import {\n    AdviceContext,\n    AdviceError,\n    AdviceType,\n    CompileAdvice,\n    JoinPoint,\n    MutableAdviceContext,\n} from '@aspectjs/core/commons';\nimport { getOrComputeMetadata, isFunction, isUndefined } from '@aspectjs/core/utils';\nimport { _defineFunctionProperties } from '../../utils';\nimport { _GenericWeavingStrategy } from './generic-weaving-strategy';\n\ntype MethodPropertyDescriptor = PropertyDescriptor & { value: (...args: any[]) => any };\n\n/**\n * @internal\n */\nexport class _MethodWeavingStrategy<T> extends _GenericWeavingStrategy<T, AdviceType.METHOD> {\n    compile(ctxt: MutableAdviceContext<T, AdviceType.METHOD>, advices: CompileAdvice<T, AdviceType.METHOD>[]) {\n        const target = ctxt.target;\n\n        // save & restore original descriptor\n        Reflect.defineProperty(\n            target.proto,\n            target.propertyKey,\n            getOrComputeMetadata(\n                'aspectjs.originalMethodDescriptor',\n                target.proto,\n                ctxt.target.propertyKey,\n                () => {\n                    return { ...Reflect.getOwnPropertyDescriptor(target.proto, target.propertyKey) };\n                },\n                true,\n            ),\n        );\n\n        let lastCompileAdvice = advices[0];\n        let newDescriptor: PropertyDescriptor;\n\n        advices.forEach((advice) => {\n            lastCompileAdvice = advice;\n            ctxt.advice = advice;\n            newDescriptor =\n                (advice(ctxt as AdviceContext<T, AdviceType.METHOD>) as PropertyDescriptor) ?? newDescriptor;\n        });\n        delete ctxt.advice;\n\n        if (isUndefined(newDescriptor)) {\n            return Reflect.getOwnPropertyDescriptor(target.proto, target.propertyKey) as MethodPropertyDescriptor;\n        } else {\n            if (Reflect.getOwnPropertyDescriptor(target.proto, target.propertyKey)?.configurable === false) {\n                throw new AdviceError(lastCompileAdvice, `${target.label} is not configurable`);\n            }\n\n            // ensure value is a function\n            if (!isFunction(newDescriptor.value)) {\n                throw new AdviceError(\n                    lastCompileAdvice,\n                    `Expected advice to return a method descriptor. Got: ${newDescriptor.value}`,\n                );\n            }\n\n            if (isUndefined(newDescriptor.enumerable)) {\n                newDescriptor.enumerable = false;\n            }\n            if (isUndefined(newDescriptor.configurable)) {\n                newDescriptor.configurable = true;\n            }\n            // test property validity\n            newDescriptor = Object.getOwnPropertyDescriptor(\n                Object.defineProperty({}, 'surrogate', newDescriptor),\n                'surrogate',\n            );\n\n            Reflect.defineProperty(target.proto, target.propertyKey, newDescriptor);\n            return newDescriptor as MethodPropertyDescriptor;\n        }\n    }\n\n    initialJoinpoint(ctxt: MutableAdviceContext<T, AdviceType.METHOD>, refDescriptor: PropertyDescriptor): void {\n        ctxt.value = refDescriptor.value.apply(ctxt.instance, ctxt.args);\n    }\n\n    finalize(ctxt: MutableAdviceContext<T, AdviceType.METHOD>, jp: JoinPoint): PropertyDescriptor {\n        const newDescriptor: PropertyDescriptor = Object.getOwnPropertyDescriptor(\n            ctxt.target.proto,\n            ctxt.target.propertyKey,\n        );\n\n        newDescriptor.value = jp;\n\n        const originalFn = ctxt.target.proto[ctxt.target.propertyKey];\n        newDescriptor.value = _defineFunctionProperties(\n            newDescriptor.value,\n            originalFn.name,\n            originalFn.toString().split('\\n')[0],\n            originalFn.toString.bind(originalFn),\n        );\n\n        Reflect.defineMetadata('aspectjs.enhancedMethodDescriptor', true, newDescriptor);\n        return newDescriptor;\n    }\n}\n"],"names":[],"mappings":"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"}