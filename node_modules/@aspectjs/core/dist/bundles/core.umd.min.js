!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports,require("@aspectjs/core/commons"),require("@aspectjs/core/annotations"),require("@aspectjs/core/utils")):"function"==typeof define&&define.amd?define(["exports","@aspectjs/core/commons","@aspectjs/core/annotations","@aspectjs/core/utils"],factory):factory(((global="undefined"!=typeof globalThis?globalThis:global||self).aspectjs=global.aspectjs||{},global.aspectjs.core={}),global.aspectjs.core_commons,global.aspectjs.core_annotations,global.aspectjs.core_utils)}(this,(function(exports,commons,annotations,utils){"use strict";function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Constructor}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function");subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,writable:!0,configurable:!0}}),superClass&&_setPrototypeOf(subClass,superClass)}function _getPrototypeOf(o){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(o){return o.__proto__||Object.getPrototypeOf(o)})(o)}function _setPrototypeOf(o,p){return(_setPrototypeOf=Object.setPrototypeOf||function(o,p){return o.__proto__=p,o})(o,p)}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _construct(Parent,args,Class){return(_construct=_isNativeReflectConstruct()?Reflect.construct:function(Parent,args,Class){var a=[null];a.push.apply(a,args);var instance=new(Function.bind.apply(Parent,a));return Class&&_setPrototypeOf(instance,Class.prototype),instance}).apply(null,arguments)}function _assertThisInitialized(self){if(void 0===self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return self}function _possibleConstructorReturn(self,call){return!call||"object"!=typeof call&&"function"!=typeof call?_assertThisInitialized(self):call}function _createSuper(Derived){var hasNativeReflectConstruct=_isNativeReflectConstruct();return function(){var result,Super=_getPrototypeOf(Derived);if(hasNativeReflectConstruct){var NewTarget=_getPrototypeOf(this).constructor;result=Reflect.construct(Super,arguments,NewTarget)}else result=Super.apply(this,arguments);return _possibleConstructorReturn(this,result)}}function _get(target,property,receiver){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(target,property,receiver){var base=function(object,property){for(;!Object.prototype.hasOwnProperty.call(object,property)&&null!==(object=_getPrototypeOf(object)););return object}(target,property);if(base){var desc=Object.getOwnPropertyDescriptor(base,property);return desc.get?desc.get.call(receiver):desc.value}})(target,property,receiver||target)}function _toConsumableArray(arr){return function(arr){if(Array.isArray(arr))return _arrayLikeToArray(arr)}(arr)||function(iter){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(iter))return Array.from(iter)}(arr)||function(o,minLen){if(!o)return;if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);"Object"===n&&o.constructor&&(n=o.constructor.name);if("Map"===n||"Set"===n)return Array.from(o);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _arrayLikeToArray(o,minLen)}(arr)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}var AspectsRegistryImpl=function(){function AspectsRegistryImpl(_weaverContext){_classCallCheck(this,AspectsRegistryImpl),this._weaverContext=_weaverContext,this._advicesRegistry={byPointcut:{},byTarget:{},byAspect:{}},this._dirty=!0,this._aspectsToLoad=new Set,this._loadedAspects=new Set,this._advicesRegistryKey="aspectjs.adviceRegistry.byAspects"}return _createClass(AspectsRegistryImpl,[{key:"register",value:function(){for(var _this=this,_len=arguments.length,aspects=new Array(_len),_key=0;_key<_len;_key++)aspects[_key]=arguments[_key];(null!=aspects?aspects:[]).forEach((function(aspect){var annotationsContext=commons._getWeaverContext().annotations,bundle=annotationsContext.bundle.at(annotationsContext.location.of(aspect)),target=_this._getTarget(aspect),byAspectRegistry=utils.locator(_this._advicesRegistry.byAspect).at(target.ref).orElseCompute((function(){return{}}));_this._aspectsToLoad.add(aspect),[[annotations.Compile,commons.PointcutPhase.COMPILE],[annotations.Before,commons.PointcutPhase.BEFORE],[annotations.Around,commons.PointcutPhase.AROUND],[annotations.After,commons.PointcutPhase.AFTER],[annotations.AfterReturn,commons.PointcutPhase.AFTERRETURN],[annotations.AfterThrow,commons.PointcutPhase.AFTERTHROW]].forEach((function(adviceDef){bundle.onMethod(adviceDef[0]).forEach((function(annotation){var expr=annotation.args[0];utils.assert(!!expr);var advice=commons._AdviceFactory.create(commons.Pointcut.of(adviceDef[1],expr),annotation.target),k="".concat(advice.pointcut.ref,"=>").concat(advice.name);byAspectRegistry[k]=advice}))}))}))}},{key:"remove",value:function(){var _this2=this;if(this._dirty=!0,this._aspectsToLoad.size){for(var _len2=arguments.length,aspects=new Array(_len2),_key2=0;_key2<_len2;_key2++)aspects[_key2]=arguments[_key2];aspects.forEach((function(a){_this2._aspectsToLoad.delete(a),delete _this2._advicesRegistry.byAspect[_this2._getTarget(a).ref]}))}this._loadedAspects.forEach((function(a){return _this2._aspectsToLoad.add(a)})),this._loadedAspects.clear()}},{key:"getAdvicesByAspect",value:function(aspect){var _a;utils.assertIsAspect(aspect);var target=this._getTarget(aspect);return Object.values(null!==(_a=this._advicesRegistry.byAspect[target.ref])&&void 0!==_a?_a:{}).flat().map((function(advice){var bound=advice.bind(aspect);return Object.defineProperties(bound,Object.getOwnPropertyDescriptors(advice)),bound}))}},{key:"getAdvicesByTarget",value:function(target,filter){var _this3=this;this._load();for(var targetRegistry=utils.locator(this._advicesRegistry).at("byTarget").at("".concat(target.ref).concat((null==filter?void 0:filter.name)?":".concat(null==filter?void 0:filter.name):"")).orElseGet((function(){return{}})),bundle=this._weaverContext.annotations.bundle.at(target.location),annotationContexts=bundle.onSelf(),_len3=arguments.length,phases=new Array(_len3>2?_len3-2:0),_key3=2;_key3<_len3;_key3++)phases[_key3-2]=arguments[_key3];return(null!=phases?phases:[]).forEach((function(phase){if(!targetRegistry[phase]){var advices=annotationContexts.map((function(annotationContext){return utils.locator(_this3._advicesRegistry).at("byPointcut").at(phase).at(target.type).at("byAnnotation").at(annotationContext.ref).orElseGet((function(){return[]}))})).flat().sort((function(a1,a2){var _a,_b,a=_this3._weaverContext.annotations;return _compareOrder(null===(_a=a.bundle.at(a.location.of(a1.aspect)[a1.name]).onMethod(annotations.Order)[0])||void 0===_a?void 0:_a.args[0],null===(_b=a.bundle.at(a.location.of(a2.aspect)[a1.name]).onMethod(annotations.Order)[0])||void 0===_b?void 0:_b.args[0])}));filter&&(advices=advices.filter(filter.fn)),targetRegistry[phase]=advices}})),targetRegistry}},{key:"_getTarget",value:function(obj){return commons.AnnotationLocationFactory.getTarget(this._weaverContext.annotations.location.of(obj))}},{key:"_load",value:function(){var _this4=this;this._dirty&&(this._advicesRegistry.byPointcut={},this._advicesRegistry.byTarget={}),this._aspectsToLoad.size&&(_toConsumableArray(this._aspectsToLoad).sort((function(a1,a2){var _a,_b,a=_this4._weaverContext.annotations;return _compareOrder(null===(_a=a.bundle.at(a.location.of(a1)).onClass(annotations.Order)[0])||void 0===_a?void 0:_a.args[0],null===(_b=a.bundle.at(a.location.of(a2)).onClass(annotations.Order)[0])||void 0===_b?void 0:_b.args[0])})).map((function(a){return _this4._loadedAspects.add(a),a})).map((function(aspect){return _this4.getAdvicesByAspect(aspect)})).flat().forEach((function(advice){var pc=advice.pointcut;utils.locator(_this4._advicesRegistry).at("byPointcut").at(pc.phase).at(pc.type).at("byAnnotation").at(pc.annotation.ref).orElseCompute((function(){return[]})).push(advice)})),this._dirty=!1,this._aspectsToLoad.clear())}}]),AspectsRegistryImpl}();function _compareOrder(o1,o2){return o1===annotations.Order.LOWEST_PRECEDENCE||void 0===o1?1:o2===annotations.Order.LOWEST_PRECEDENCE||void 0===o2||o1===annotations.Order.HIGHEST_PRECEDENCE?-1:o2===annotations.Order.HIGHEST_PRECEDENCE?1:o1-o2}var _AdviceExecutionPlanFactory=function(){function _AdviceExecutionPlanFactory(){_classCallCheck(this,_AdviceExecutionPlanFactory)}return _createClass(_AdviceExecutionPlanFactory,[{key:"create",value:function(target,hooks,filter){var compiledSymbol,compiled=!1,compileFn=function(ctxt){var compileAdvices=commons._getWeaverContext().aspects.registry.getAdvicesByTarget(ctxt.target,filter,commons.PointcutPhase.COMPILE)[commons.PointcutPhase.COMPILE];if(compiledSymbol=hooks.compile(ctxt,compileAdvices),compiled=!0,!compiledSymbol)throw new commons.WeavingError("".concat(Reflect.getPrototypeOf(hooks).constructor.name,".compile() did not returned a symbol"));return compiledSymbol};return new _ExecutionPlan(compileFn,(function(ctxt){var _a;compiled||compileFn(ctxt),utils.assert(!!compiledSymbol);var jp=function(){for(var _a,_len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];ctxt.args=args,ctxt.instance=this;var advicesReg=commons._getWeaverContext().aspects.registry.getAdvicesByTarget(ctxt.target,filter,commons.PointcutPhase.BEFORE,commons.PointcutPhase.AROUND,commons.PointcutPhase.AFTERRETURN,commons.PointcutPhase.AFTERTHROW,commons.PointcutPhase.AFTER),jp=commons._JoinpointFactory.create(null,ctxt,(function(){for(var _a,_b,_c,_d,restoreJp=ctxt.joinpoint,restoreArgs=ctxt.args,_len2=arguments.length,args=new Array(_len2),_key2=0;_key2<_len2;_key2++)args[_key2]=arguments[_key2];ctxt.args=args,delete ctxt.joinpoint;try{return null===(_a=hooks.preBefore)||void 0===_a||_a.call(hooks,ctxt),hooks.before(ctxt,advicesReg[commons.PointcutPhase.BEFORE]),hooks.initialJoinpoint.call(hooks,ctxt,compiledSymbol),null===(_b=hooks.preAfterReturn)||void 0===_b||_b.call(hooks,ctxt),hooks.afterReturn(ctxt,advicesReg[commons.PointcutPhase.AFTERRETURN])}catch(e){if(e instanceof commons.WeavingError)throw e;return ctxt.error=e,null===(_c=hooks.preAfterThrow)||void 0===_c||_c.call(hooks,ctxt),hooks.afterThrow(ctxt,advicesReg[commons.PointcutPhase.AFTERTHROW])}finally{delete ctxt.error,null===(_d=hooks.preAfter)||void 0===_d||_d.call(hooks,ctxt),hooks.after(ctxt,advicesReg[commons.PointcutPhase.AFTER]),ctxt.joinpoint=restoreJp,ctxt.args=restoreArgs}}));return null===(_a=hooks.preAround)||void 0===_a||_a.call(hooks,ctxt),hooks.around(ctxt,advicesReg[commons.PointcutPhase.AROUND],jp)(args)};return null!==(_a=hooks.finalize.call(hooks,ctxt,jp))&&void 0!==_a?_a:jp}))}}]),_AdviceExecutionPlanFactory}(),_ExecutionPlan=function(){function _ExecutionPlan(compileFn,linkFn){_classCallCheck(this,_ExecutionPlan),this.compileFn=compileFn,this.linkFn=linkFn}return _createClass(_ExecutionPlan,[{key:"compile",value:function(ctxt){var compiled=this.compileFn(ctxt),_link=this.linkFn;return{link:function(){return _link(ctxt,compiled)}}}}]),_ExecutionPlan}();function _defineFunctionProperties(fn,name,tag,toString){utils.assert("function"==typeof fn);var newFn=new Function("fn","return function ".concat(name,"(...args) { return fn.apply(this, args) };"))(fn);return Object.defineProperty(newFn,"name",{value:name}),tag=null!=tag?tag:name,Object.defineProperty(newFn,Symbol.toPrimitive,{enumerable:!1,configurable:!0,value:function(){return tag}}),newFn.prototype.toString=toString,newFn.toString=toString,newFn}var _GenericWeavingStrategy=function(){function _GenericWeavingStrategy(){_classCallCheck(this,_GenericWeavingStrategy)}return _createClass(_GenericWeavingStrategy,[{key:"after",value:function(ctxt,advices){this._applyNonReturningAdvices(ctxt,advices)}},{key:"afterReturn",value:function(ctxt,advices){return ctxt.value=ctxt.value,advices.forEach((function(advice){ctxt.value=advice(ctxt,ctxt.value)})),ctxt.value}},{key:"afterThrow",value:function(ctxt,advices){var _a,allowReturn=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(advices.length)return ctxt.value=null!==(_a=ctxt.value)&&void 0!==_a?_a:void 0,advices.forEach((function(advice){if(ctxt.advice=advice,ctxt.value=advice(ctxt,ctxt.error),delete ctxt.advice,!allowReturn&&!utils.isUndefined(ctxt.value))throw new commons.AdviceError(advice,"Returning from advice is not supported")})),ctxt.value;throw utils.assert(!!ctxt.error),ctxt.error}},{key:"around",value:function(ctxt,advices,jp){var allowReturn=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];return advices.reverse().forEach((function(advice){var originalJp=jp,nextJp=commons._JoinpointFactory.create(advice,ctxt,(function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return originalJp(args)}));jp=function(args){if(ctxt.joinpoint=nextJp,ctxt.args=args,ctxt.advice=advice,ctxt.value=advice(ctxt,nextJp,args),void 0!==ctxt.value&&!allowReturn)throw new commons.AdviceError(advice,"Returning from advice is not supported");return ctxt.value}})),jp}},{key:"before",value:function(ctxt,advices){this._applyNonReturningAdvices(ctxt,advices)}},{key:"_applyNonReturningAdvices",value:function(ctxt,advices){advices.forEach((function(advice){ctxt.advice=advice;var retVal=advice(ctxt);if(delete ctxt.advice,!utils.isUndefined(retVal))throw new commons.AdviceError(advice,"Returning from advice is not supported")}))}}]),_GenericWeavingStrategy}(),_ClassWeavingStrategy=function(_GenericWeavingStrate){_inherits(_ClassWeavingStrategy,_GenericWeavingStrate);var _super=_createSuper(_ClassWeavingStrategy);function _ClassWeavingStrategy(){return _classCallCheck(this,_ClassWeavingStrategy),_super.apply(this,arguments)}return _createClass(_ClassWeavingStrategy,[{key:"compile",value:function(ctxt,advices){var ctor;return ctxt.target.proto.constructor=utils._getReferenceConstructor(ctxt.target.proto),utils._setReferenceConstructor(ctxt.target.proto,ctxt.target.proto.constructor),advices.forEach((function(advice){ctxt.advice=advice,ctor=advice(ctxt)})),delete ctxt.advice,ctxt.target.proto.constructor=null!=ctor?ctor:ctxt.target.proto.constructor}},{key:"preAround",value:function(ctxt){this.originalInstance=ctxt.instance,ctxt.instance=null}},{key:"around",value:function(ctxt,advices,joinpoint){return advices.reverse().forEach((function(advice){var originalJp=joinpoint,nextJp=commons._JoinpointFactory.create(advice,ctxt,(function(){for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];return originalJp(args)}));joinpoint=function(args){var _a;return ctxt.joinpoint=nextJp,ctxt.args=args,ctxt.advice=advice,ctxt.instance=null!==(_a=advice(ctxt,nextJp,args))&&void 0!==_a?_a:ctxt.instance}})),joinpoint}},{key:"initialJoinpoint",value:function(ctxt,originalCtor){var _a;Object.assign(this.originalInstance,null!==(_a=_construct(originalCtor,_toConsumableArray(ctxt.args)))&&void 0!==_a?_a:this.originalInstance),ctxt.instance=this.originalInstance}},{key:"afterReturn",value:function(ctxt,advices){var newInstance=ctxt.instance;return advices.forEach((function(advice){ctxt.value=ctxt.instance,ctxt.advice=advice,newInstance=advice(ctxt,ctxt.value),utils.isUndefined(newInstance)||(ctxt.instance=newInstance),delete ctxt.advice})),ctxt.instance}},{key:"preAfterThrow",value:function(ctxt){ctxt.instance=this.originalInstance}},{key:"afterThrow",value:function(ctxt,advices){if(advices.length){var newInstance=ctxt.instance;return advices.forEach((function(advice){ctxt.advice=advice,newInstance=advice(ctxt,ctxt.error),utils.isUndefined(newInstance)||(ctxt.instance=newInstance),delete ctxt.advice})),ctxt.instance}throw ctxt.error}},{key:"finalize",value:function(ctxt,joinpoint){var _a;utils.assert(!!(null===(_a=ctxt.target)||void 0===_a?void 0:_a.proto));var originalCtor=ctxt.target.proto.constructor,ctorName=originalCtor.name;return(joinpoint=_defineFunctionProperties(joinpoint,ctorName,"class ".concat(ctorName,"$$advised {}"),originalCtor.toString.bind(originalCtor))).prototype=ctxt.target.proto,joinpoint.prototype.constructor=joinpoint,joinpoint}}]),_ClassWeavingStrategy}(_GenericWeavingStrategy),_MethodWeavingStrategy=function(_GenericWeavingStrate){_inherits(_MethodWeavingStrategy,_GenericWeavingStrate);var _super=_createSuper(_MethodWeavingStrategy);function _MethodWeavingStrategy(){return _classCallCheck(this,_MethodWeavingStrategy),_super.apply(this,arguments)}return _createClass(_MethodWeavingStrategy,[{key:"compile",value:function(ctxt,advices){var _a,target=ctxt.target;Reflect.defineProperty(target.proto,target.propertyKey,utils.getOrComputeMetadata("aspectjs.originalMethodDescriptor",target.proto,ctxt.target.propertyKey,(function(){return Object.assign({},Reflect.getOwnPropertyDescriptor(target.proto,target.propertyKey))}),!0));var newDescriptor,lastCompileAdvice=advices[0];if(advices.forEach((function(advice){var _a;lastCompileAdvice=advice,ctxt.advice=advice,newDescriptor=null!==(_a=advice(ctxt))&&void 0!==_a?_a:newDescriptor})),delete ctxt.advice,utils.isUndefined(newDescriptor))return Reflect.getOwnPropertyDescriptor(target.proto,target.propertyKey);if(!1===(null===(_a=Reflect.getOwnPropertyDescriptor(target.proto,target.propertyKey))||void 0===_a?void 0:_a.configurable))throw new commons.AdviceError(lastCompileAdvice,"".concat(target.label," is not configurable"));if(!utils.isFunction(newDescriptor.value))throw new commons.AdviceError(lastCompileAdvice,"Expected advice to return a method descriptor. Got: ".concat(newDescriptor.value));return utils.isUndefined(newDescriptor.enumerable)&&(newDescriptor.enumerable=!1),utils.isUndefined(newDescriptor.configurable)&&(newDescriptor.configurable=!0),newDescriptor=Object.getOwnPropertyDescriptor(Object.defineProperty({},"surrogate",newDescriptor),"surrogate"),Reflect.defineProperty(target.proto,target.propertyKey,newDescriptor),newDescriptor}},{key:"initialJoinpoint",value:function(ctxt,refDescriptor){ctxt.value=refDescriptor.value.apply(ctxt.instance,ctxt.args)}},{key:"finalize",value:function(ctxt,jp){var newDescriptor=Object.getOwnPropertyDescriptor(ctxt.target.proto,ctxt.target.propertyKey);newDescriptor.value=jp;var originalFn=ctxt.target.proto[ctxt.target.propertyKey];return newDescriptor.value=_defineFunctionProperties(newDescriptor.value,originalFn.name,originalFn.toString().split("\n")[0],originalFn.toString.bind(originalFn)),Reflect.defineMetadata("aspectjs.enhancedMethodDescriptor",!0,newDescriptor),newDescriptor}}]),_MethodWeavingStrategy}(_GenericWeavingStrategy),_defineProperty$1=Object.defineProperty,_ParameterWeavingStrategy=function(_MethodWeavingStrateg){_inherits(_ParameterWeavingStrategy,_MethodWeavingStrateg);var _super=_createSuper(_ParameterWeavingStrategy);function _ParameterWeavingStrategy(){return _classCallCheck(this,_ParameterWeavingStrategy),_super.call(this)}return _createClass(_ParameterWeavingStrategy,[{key:"compile",value:function(ctxt,advices){var target=ctxt.target,originalDescriptor=utils.getOrComputeMetadata("aspectjs.originalPropertyDescriptor",target.proto,ctxt.target.propertyKey,(function(){return Object.assign({},Reflect.getOwnPropertyDescriptor(target.proto,target.propertyKey))}),!0);return Reflect.defineProperty(target.proto,target.propertyKey,originalDescriptor),Reflect.defineMetadata("aspectjs.originalMethodDescriptor",originalDescriptor,target.proto,target.propertyKey),_get(_getPrototypeOf(_ParameterWeavingStrategy.prototype),"compile",this).call(this,ctxt,advices)}},{key:"finalize",value:function(ctxt,jp){var newDescriptor=_get(_getPrototypeOf(_ParameterWeavingStrategy.prototype),"finalize",this).call(this,ctxt,jp);return Reflect.defineProperty(ctxt.target.proto,ctxt.target.propertyKey,newDescriptor),Reflect.defineMetadata("aspectjs.originalMethodDescriptor",newDescriptor,ctxt.target.proto,ctxt.target.propertyKey),Object.defineProperty=function(o,p,attributes){return o===ctxt.target.proto&&p===ctxt.target.propertyKey?(Object.defineProperty=_defineProperty$1,Reflect.getOwnMetadata("aspectjs.enhancedMethodDescriptor",attributes)?Object.defineProperty(o,p,attributes):newDescriptor):_defineProperty$1(o,p,attributes)},newDescriptor}}]),_ParameterWeavingStrategy}(_MethodWeavingStrategy),_PropertyGetWeavingStrategy=function(_GenericWeavingStrate){_inherits(_PropertyGetWeavingStrategy,_GenericWeavingStrate);var _super=_createSuper(_PropertyGetWeavingStrategy);function _PropertyGetWeavingStrategy(){return _classCallCheck(this,_PropertyGetWeavingStrategy),_super.apply(this,arguments)}return _createClass(_PropertyGetWeavingStrategy,[{key:"compile",value:function(ctxt,advices){var _a,target=ctxt.target;if(this.compiledDescriptor)return this.compiledDescriptor;target.descriptor=utils.getOrComputeMetadata("aspectjs.originalDescriptor",target.proto,target.propertyKey,(function(){var _a;return null!==(_a=Reflect.getOwnPropertyDescriptor(target.proto,target.propertyKey))&&void 0!==_a?_a:{configurable:!0,enumerable:!0,get:function(){return Reflect.getOwnMetadata("aspectjs.propValue",this,target.propertyKey)},set:function(value){Reflect.defineMetadata("aspectjs.propValue",value,this,target.propertyKey)}}}),!0);var newDescriptor=ctxt.target.descriptor;if(advices.forEach((function(advice){var _a;ctxt.advice=advice,newDescriptor=null!==(_a=advice(ctxt))&&void 0!==_a?_a:newDescriptor})),delete ctxt.advice,newDescriptor){if(!1===(null===(_a=Reflect.getOwnPropertyDescriptor(target.proto,target.propertyKey))||void 0===_a?void 0:_a.configurable))throw new commons.AdviceError(undefined,"".concat(target.label," is not configurable"));var surrogate={prop:""},surrogateProp=Reflect.getOwnPropertyDescriptor(surrogate,"prop");utils.isUndefined(newDescriptor.enumerable)&&(newDescriptor.enumerable=surrogateProp.enumerable),utils.isUndefined(newDescriptor.configurable)&&(newDescriptor.configurable=surrogateProp.configurable),newDescriptor=Object.getOwnPropertyDescriptor(Object.defineProperty(surrogate,"newProp",newDescriptor),"newProp"),Reflect.defineProperty(target.proto,target.propertyKey,newDescriptor)}if(newDescriptor.hasOwnProperty("value")){var propValue=newDescriptor.value;newDescriptor.get=function(){return propValue},delete newDescriptor.writable,delete newDescriptor.value}return this.compiledDescriptor=newDescriptor}},{key:"preBefore",value:function(ctxt){ctxt.args=[]}},{key:"initialJoinpoint",value:function(ctxt,originalDescriptor){utils.assert(utils.isFunction(originalDescriptor.get)),ctxt.value=commons._JoinpointFactory.create(null,ctxt,originalDescriptor.get)()}},{key:"finalize",value:function(ctxt,joinpoint){var newDescriptor=Object.assign(Object.assign({},this.compiledDescriptor),{get:joinpoint});return Object.getOwnPropertyDescriptor(Object.defineProperty({},"surrogate",newDescriptor),"surrogate"),newDescriptor}}]),_PropertyGetWeavingStrategy}(_GenericWeavingStrategy),_PropertySetWeavingStrategy=function(_GenericWeavingStrate){_inherits(_PropertySetWeavingStrategy,_GenericWeavingStrate);var _super=_createSuper(_PropertySetWeavingStrategy);function _PropertySetWeavingStrategy(getterHooks){var _this;return _classCallCheck(this,_PropertySetWeavingStrategy),(_this=_super.call(this)).getterHooks=getterHooks,_this}return _createClass(_PropertySetWeavingStrategy,[{key:"compile",value:function(ctxt){return this.compiledDescriptor=this.getterHooks.compile(ctxt,null)}},{key:"initialJoinpoint",value:function(ctxt,refDescriptor){utils.assert(utils.isFunction(null==refDescriptor?void 0:refDescriptor.set)),ctxt.value=commons._JoinpointFactory.create(null,ctxt,refDescriptor.set)(ctxt.args)}},{key:"around",value:function(ctxt,advices,jp){return _get(_getPrototypeOf(_PropertySetWeavingStrategy.prototype),"around",this).call(this,ctxt,advices,jp,!1)}},{key:"afterReturn",value:function(ctxt,advices){return this._applyNonReturningAdvices(ctxt,advices)}},{key:"afterThrow",value:function(ctxt,advices){_get(_getPrototypeOf(_PropertySetWeavingStrategy.prototype),"afterThrow",this).call(this,ctxt,advices,!1)}},{key:"after",value:function(ctxt,advices){this._applyNonReturningAdvices(ctxt,advices)}},{key:"finalize",value:function(ctxt,joinpoint){var newDescriptor=Object.assign(Object.assign({},this.compiledDescriptor),{set:joinpoint});return Object.getOwnPropertyDescriptor(Object.defineProperty({},"surrogate",newDescriptor),"surrogate"),newDescriptor}}]),_PropertySetWeavingStrategy}(_GenericWeavingStrategy),JitWeaver=function(_WeaverProfile){_inherits(JitWeaver,_WeaverProfile);var _super=_createSuper(JitWeaver);function JitWeaver(_context){var _this$_enhancers,_this,_prod=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return _classCallCheck(this,JitWeaver),(_this=_super.call(this))._context=_context,_this._prod=_prod,_this._enhancers=(_defineProperty(_this$_enhancers={},commons.AnnotationType.CLASS,_this._enhanceClass.bind(_assertThisInitialized(_this))),_defineProperty(_this$_enhancers,commons.AnnotationType.PROPERTY,_this._enhanceProperty.bind(_assertThisInitialized(_this))),_defineProperty(_this$_enhancers,commons.AnnotationType.METHOD,_this._enhanceMethod.bind(_assertThisInitialized(_this))),_defineProperty(_this$_enhancers,commons.AnnotationType.PARAMETER,_this._enhanceParameter.bind(_assertThisInitialized(_this))),_this$_enhancers),_this._planFactory=new _AdviceExecutionPlanFactory,_this}return _createClass(JitWeaver,[{key:"enable",value:function(){var _WeaverProfile2,_this2=this,_aspects=(_WeaverProfile2=new commons.WeaverProfile).enable.apply(_WeaverProfile2,arguments).getAspects();try{var _this$_context$aspect,_get2;if((_this$_context$aspect=this._context.aspects.registry).register.apply(_this$_context$aspect,_toConsumableArray(_aspects)),this._prod){var alreadyProcessedAnnotations=new Map;_aspects.forEach((function(aspect){_this2._context.aspects.registry.getAdvicesByAspect(aspect).forEach((function(a){return alreadyProcessedAnnotations.set(a.pointcut,aspect)}))})),alreadyProcessedAnnotations.forEach((function(aspect,pointcut){var _a,_b;if(_this2._context.annotations.bundle.all(pointcut.annotation.ref).length)throw new commons.WeavingError("Cannot enable aspect ".concat(null!==(_b=null===(_a=aspect.constructor)||void 0===_a?void 0:_a.name)&&void 0!==_b?_b:aspect," because annotation ").concat(pointcut.annotation," has already been applied"))}))}var r=(_get2=_get(_getPrototypeOf(JitWeaver.prototype),"enable",this)).call.apply(_get2,[this].concat(_toConsumableArray(_aspects)));return _aspects.filter((function(a){return utils.isFunction(a.onEnable)})).forEach((function(a){return a.onEnable.call(a,_this2)})),r}catch(e){var _this$_context$aspect2;throw(_this$_context$aspect2=this._context.aspects.registry).remove.apply(_this$_context$aspect2,_toConsumableArray(_aspects)),e}}},{key:"disable",value:function(){var _WeaverProfile3,_get3,_this3=this,_aspects=(_WeaverProfile3=new commons.WeaverProfile).enable.apply(_WeaverProfile3,arguments).getAspects();return _aspects.filter((function(a){return utils.isFunction(a.onDisable)})).forEach((function(a){return a.onEnable.call(a,_this3)})),(_get3=_get(_getPrototypeOf(JitWeaver.prototype),"disable",this)).call.apply(_get3,[this].concat(_toConsumableArray(_aspects)))}},{key:"reset",value:function(){return this._planFactory=new _AdviceExecutionPlanFactory,_get(_getPrototypeOf(JitWeaver.prototype),"reset",this).call(this)}},{key:"enhance",value:function(target){var ctxt=new AdviceContextImpl(target,this._context.annotations.bundle.at(target.location));return this._enhancers[target.type](ctxt)}},{key:"_enhanceClass",value:function(ctxt){return this._planFactory.create(ctxt.target,new _ClassWeavingStrategy).compile(ctxt).link()}},{key:"_enhanceProperty",value:function(ctxt){var desc,getterHooks=new _PropertyGetWeavingStrategy,newDescriptor=this._planFactory.create(ctxt.target,getterHooks,{name:"get",fn:_isPropertyGet}).compile(ctxt).link();if(!(desc=newDescriptor)||desc.hasOwnProperty("writable")&&desc.writable||utils.isFunction(desc.set)){var settersPlan=this._planFactory.create(ctxt.target,new _PropertySetWeavingStrategy(getterHooks),{name:"set",fn:_isPropertySet});newDescriptor.set=settersPlan.compile(ctxt).link().set,delete newDescriptor.writable}else delete newDescriptor.set;var target=ctxt.target;return Reflect.defineProperty(target.proto,target.propertyKey,newDescriptor),newDescriptor}},{key:"_enhanceMethod",value:function(ctxt){return this._planFactory.create(ctxt.target,new _MethodWeavingStrategy).compile(ctxt).link()}},{key:"_enhanceParameter",value:function(ctxt){return this._planFactory.create(ctxt.target,new _ParameterWeavingStrategy).compile(ctxt).link()}}]),JitWeaver}(commons.WeaverProfile);function _isPropertyGet(a){return a.pointcut.ref.startsWith("property#get")}function _isPropertySet(a){return a.pointcut.ref.startsWith("property#set")}var AdviceContextImpl=function(){function AdviceContextImpl(target,bundle){_classCallCheck(this,AdviceContextImpl),this.target=target,this.data={},this.annotations=bundle}return _createClass(AdviceContextImpl,[{key:"clone",value:function(){return Object.assign(Object.create(Reflect.getPrototypeOf(this)),this)}},{key:"toString",value:function(){return"".concat(this.advice," on ").concat(this.target.label)}}]),AdviceContextImpl}(),bundleRegistry={byTargetClassRef:{},byAnnotation:{}},bundle=new commons.RootAnnotationsBundle(bundleRegistry),annotationRegistry=new commons.AnnotationRegistry(bundleRegistry),WeaverContextImpl=function(){function WeaverContextImpl(){_classCallCheck(this,WeaverContextImpl),this._targetFactory=new commons.AnnotationTargetFactory,this.annotations={location:new commons.AnnotationLocationFactory(this._targetFactory),registry:annotationRegistry,targetFactory:this._targetFactory,bundle:bundle},this.aspects={registry:new AspectsRegistryImpl(this)},this.weaver=this._createWeaver()}return _createClass(WeaverContextImpl,[{key:"_createWeaver",value:function(){return new JitWeaver(this)}},{key:"getWeaver",value:function(){return this.weaver}}]),WeaverContextImpl}(),WEAVER_CONTEXT=new(function(){function _class(){_classCallCheck(this,_class)}return _createClass(_class,[{key:"getWeaver",value:function(){return commons._getWeaverContext().getWeaver()}},{key:"aspects",get:function(){return commons._getWeaverContext().aspects}},{key:"annotations",get:function(){return commons._getWeaverContext().annotations}}]),_class}());commons._setWeaverContext(new WeaverContextImpl),exports.JitWeaver=JitWeaver,exports.WEAVER_CONTEXT=WEAVER_CONTEXT,exports.WeaverContextImpl=WeaverContextImpl,exports._AdviceExecutionPlanFactory=_AdviceExecutionPlanFactory,exports._ExecutionPlan=_ExecutionPlan}));
//# sourceMappingURL=core.umd.min.js.map
